<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Simple, secure 2FA code generator that works locally in your browser. Built with Claude & Cursor.">
    <meta name="theme-color" content="#007bff">
    <title>2FA Code Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-primary: #f5f5f5;
            --bg-secondary: #f8f9fa;
            --border-color: #ddd;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.2s ease-in-out;
            --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-duration: 0.3s;
            --hover-transform: translateY(-2px);
            --hover-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            min-height: 100%;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-size: 2rem;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all var(--transition-duration) var(--transition-timing);
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            font-weight: 500;
            transition: transform var(--transition-duration) var(--transition-timing),
                        box-shadow var(--transition-duration) var(--transition-timing);
        }

        button:hover {
            transform: var(--hover-transform);
            box-shadow: var(--hover-shadow);
        }

        .codes-container {
            margin: 0 -2rem;
            padding: 0 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            position: relative;
            mask-image: linear-gradient(
                to bottom,
                transparent,
                black 1rem,
                black calc(100% - 1rem),
                transparent
            );
            -webkit-mask-image: linear-gradient(
                to bottom,
                transparent,
                black 1rem,
                black calc(100% - 1rem),
                transparent
            );
        }

        .codes-container-inner {
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .code-display {
            display: flex;
            align-items: center;
            padding: var(--spacing-lg);
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            position: relative;
            border: 1px solid var(--border-color);
            gap: var(--spacing-lg);
            overflow: hidden;
            min-height: 90px;
            flex-shrink: 0;
            justify-content: space-between;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        outline-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            outline: 2px solid transparent;
            outline-offset: 2px;
        }

        .code-display:hover {
            background-color: white;
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
            border-color: var(--border-color);
        }

        .code-display:focus-within {
            outline-color: var(--primary-color);
        }

        .account-name-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
            max-width: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .code-display:hover .account-name-container {
            transform: translateX(4px);
        }

        .account-name {
            font-weight: 500;
            font-size: 0.95rem;
            margin: 0;
            word-break: break-word;
            line-height: 1.4;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .code-display:hover .account-name {
            font-weight: 600;
            transform: scale(1.02);
        }

        .account-name-container:hover .account-name {
            color: var(--primary-color);
        }

        .account-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity var(--transition-duration) var(--transition-timing);
            flex-shrink: 0;
        }

        .account-name-container:hover .account-actions {
            opacity: 1;
        }

        .account-action-btn {
            position: relative;
            background: none;
            border: none;
            padding: 0.25rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all var(--transition-duration) var(--transition-timing);
        }

        .account-action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }

        .account-action-btn .action-tooltip {
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            opacity: 0;
            pointer-events: none;
            transition: all var(--transition-duration) var(--transition-timing);
            white-space: nowrap;
        }

        .account-action-btn:hover .action-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-2px);
        }

        .account-action-btn.edit:hover {
            color: var(--primary-color);
        }

        .account-action-btn.delete:hover {
            color: var(--danger-color);
        }

        .account-action-btn.delete.confirm {
            color: var(--danger-color);
            background: rgba(220, 53, 69, 0.1);
        }

        .account-action-btn.delete.confirm .action-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-2px);
            background: var(--danger-color);
        }

        .code-wrapper {
            position: relative;
            padding: 0.75rem 1.25rem;
            background: rgba(0, 0, 0, 0.03);
            border-radius: var(--border-radius);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            min-width: 160px;
            text-align: center;
            margin-left: auto;
            border: 1px solid transparent;
        }

        .code-wrapper:hover {
            background: rgba(0, 123, 255, 0.05);
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
        }

        .code-wrapper.copied {
            background: rgba(0, 123, 255, 0.08);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .code {
            font-size: 2rem;
            font-family: 'SF Mono', 'Cascadia Code', Consolas, monospace;
            color: var(--text-primary);
            letter-spacing: 3px;
            font-weight: 600;
            margin: 0;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        .code:hover {
            color: var(--primary-color);
            transform: scale(1.02);
            letter-spacing: 4px;
        }

        .delete-btn {
            background-color: transparent;
            color: var(--danger-color);
            border: none;
            width: 24px;
            height: 24px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
            padding: 0;
            line-height: 1;
            flex-shrink: 0;
            border-radius: 4px;
        }

        .account-name-container:hover .delete-btn {
            opacity: 0.7;
        }

        .delete-btn:hover {
            opacity: 1 !important;
            background-color: rgba(220, 53, 69, 0.1);
        }

        .footer {
            text-align: center;
            padding: 1.25rem 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            margin: 0 -2rem -2rem;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            opacity: 0.9;
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        /* Mobile styles */
        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
                height: 100%;
            }

            .container {
                padding: var(--spacing-md);
            }

            h1 {
                font-size: 1.75rem;
            }

            .code-display {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
                padding: 1rem;
            }

            .account-name-container {
                max-width: none;
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                margin-right: 0;
            }

            .account-name {
                font-size: 1rem;
                max-width: calc(100% - 80px); /* Leave space for buttons */
            }

            .account-actions {
                opacity: 0.7;
                position: static;
                display: flex;
                gap: 0.5rem;
                margin-left: auto;
            }

            .account-action-btn {
                width: 36px;
                height: 36px;
                background: rgba(0, 0, 0, 0.03);
            }

            .code-wrapper {
                margin: 0;
                width: 100%;
                padding: 0.75rem;
                background: rgba(0, 0, 0, 0.02);
            }

            .code {
                font-size: 1.75rem;
                letter-spacing: 2px;
            }

            /* Remove swipe hint since we're showing buttons */
            .account-name-container::after {
                display: none;
            }

            /* Hide tooltips on mobile */
            .action-tooltip,
            .tooltip {
                display: none;
            }

            /* Adjust timer progress for mobile */
            .timer-progress {
                border-width: 1.5px;
            }

            /* Improve tap targets */
            .account-action-btn {
                font-size: 1.1rem;
            }

            /* Adjust copy animation for mobile */
            .code-wrapper.copied::after {
                font-size: 2rem;
            }
        }

        .search-box {
            margin: 0 0 1.5rem 0;
            position: relative;
        }

        .search-box::after {
            content: 'üîç';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            pointer-events: none;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all var(--transition-duration) var(--transition-timing);
            background: var(--bg-secondary);
        }

        .search-box input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background: white;
        }

        .add-account-section {
            background: white;
            padding: 1.75rem 2rem;
            margin: 0 -2rem;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            position: relative;
            z-index: 5;
            border-top: 1px solid var(--border-color);
        }

        .add-account-form {
            display: block;
            position: absolute;
            bottom: 100%;
            left: 1rem;
            right: 1rem;
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(10px);
            z-index: 10;
            pointer-events: none;
            visibility: hidden;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        visibility 0.3s;
        }

        .add-account-form.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }

        .add-account-form h2 {
            margin: 0 0 1rem;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .add-account-form .input-group {
            margin-bottom: 1.5rem;
        }

        .add-account-form .input-group:last-of-type {
            margin-bottom: 2rem;
        }

        .add-account-form input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background: var(--bg-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .add-account-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background: white;
        }

        .add-account-form button {
            margin-bottom: 0.5rem;
        }

        .import-export {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            margin: 0;
        }

        .import-export button:not(.toggle-btn) {
            flex: 1;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 120px;
            font-size: 0.95rem;
        }

        .import-export button:not(.toggle-btn):hover {
            background-color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            z-index: 10;
            line-height: 1;
        }

        .delete-btn:hover .tooltip

        .delete-btn .tooltip {
            right: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%);
        }

        .code-wrapper .tooltip {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .code-wrapper:hover .tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }

        .copy-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            font-weight: 500;
            font-size: 1rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-duration) var(--transition-timing);
        }

        .code-wrapper.copied .code {
            opacity: 0;
        }

        .code-wrapper.copied .copy-indicator {
            opacity: 1;
        }

        /* Scrollbar styles */
        @media screen and (min-width: 768px) {
            .codes-container {
                /* For Firefox */
                scrollbar-width: thin;
                scrollbar-color: transparent transparent;
            }

            .codes-container:hover {
                scrollbar-color: var(--border-color) transparent;
            }

            /* For Webkit browsers */
            .codes-container::-webkit-scrollbar {
                width: 6px;
                position: absolute;
                right: 0;
            }

            .codes-container::-webkit-scrollbar-track {
                background: transparent;
            }

            .codes-container::-webkit-scrollbar-thumb {
                background-color: var(--border-color);
                border-radius: 20px;
                border: 2px solid transparent;
                background-clip: content-box;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .codes-container:hover::-webkit-scrollbar-thumb {
                opacity: 0.5;
            }

            .codes-container:hover::-webkit-scrollbar-thumb:hover {
                opacity: 1;
                background-color: var(--text-secondary);
            }
        }

        .section-divider {
            margin: auto -2rem 0;
            height: 1px;
            background: transparent;
            border: none;
            margin-bottom: -1px; /* To prevent double border with add-account-section */
        }

        .toggle-btn {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            width: 48px;
            height: 48px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
            margin: 0 0.5rem;
            border-radius: var(--border-radius);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        }

        .toggle-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .button-loading {
            position: relative;
            color: transparent !important;
            cursor: not-allowed;
        }

        .button-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin: -8px 0 0 -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: button-loading-spinner 0.6s linear infinite;
        }

        @keyframes button-loading-spinner {
            to {
                transform: rotate(360deg);
            }
        }

        /* Update timer progress styles */
        .timer-progress {
            position: absolute;
            pointer-events: none;
            inset: 0;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            opacity: 0.15;
            clip-path: inset(0 0 0 0); /* Start fully visible */
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        clip-path 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Add initial transition */
        }

        .timer-progress.animate {
            clip-path: inset(0 0 0 var(--progress));
            transition: clip-path 1s linear; /* Keep linear transition for the timer */
        }

        /* Add hover effect for timer */
        .code-display:hover .timer-progress {
            opacity: 0.3;
            border-width: 3px;
        }

        /* Dialog base styles */
        .dialog,
        .edit-account-dialog,
        .add-account-form {
            position: absolute;
            bottom: 100%;
            left: 1rem;
            right: 1rem;
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            box-shadow: var(--hover-shadow);
            margin-bottom: var(--spacing-md);
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            visibility: hidden;
            transition: opacity var(--transition-duration) var(--transition-timing),
                        transform var(--transition-duration) var(--transition-timing),
                        visibility var(--transition-duration);
            z-index: 10;
        }

        .dialog-base.visible,
        .edit-account-dialog.visible,
        .add-account-form.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }

        .dialog-content {
            width: 100%;
        }

        .dialog h2,
        .edit-account-dialog h2,
        .add-account-form h2 {
            margin: 0 0 1rem;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .dialog-description {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .dialog textarea {
            width: 100%;
            height: 150px;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'SF Mono', 'Cascadia Code', Consolas, monospace;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            resize: none;
            transition: all var(--transition-duration) var(--transition-timing);
        }

        .dialog textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* Dialog buttons */
        .dialog-buttons {
            display: flex;
            gap: 1rem;
        }

        .dialog-buttons button {
            flex: 1;
        }

        .dialog-buttons .secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .dialog-buttons .secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--text-secondary);
        }

        .dialog-buttons button.copied {
            background-color: var(--primary-color);
            color: white;
        }

        /* Update toast styles */
        .toast {
            position: fixed;
            bottom: 4rem;
            left: 50%;
            transform: translate(-50%, 100%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            pointer-events: none;
            text-align: center;
            min-width: 200px;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .toast.visible {
            opacity: 1;
            transform: translate(-50%, 0);
            pointer-events: auto;
        }

        /* Update toast button styles */
        .toast button {
            background: none;
            border: none;
            color: white;
            text-decoration: underline;
            padding: 0;
            margin: 0;
            font-size: inherit;
            cursor: pointer;
            width: auto;
            min-width: auto;
            font-weight: normal;
        }

        .toast button:hover {
            text-decoration: none;
            transform: none;
            box-shadow: none;
            background: none;
        }

        .toast-success {
            background: rgba(40, 167, 69, 0.95);
        }

        .toast-warning {
            background: rgba(255, 193, 7, 0.95);
        }

        .toast-error {
            background: rgba(220, 53, 69, 0.95);
        }

        .toast-info {
            background: rgba(0, 123, 255, 0.95);
        }

        /* Add loading skeleton animation */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 0.3; }
            100% { opacity: 0.6; }
        }

        .code.loading {
            background: var(--border-color);
            color: transparent;
            animation: pulse 1.5s infinite;
            border-radius: 4px;
        }

        /* Add highlight for search results */
        mark {
            background-color: rgba(0, 123, 255, 0.2);
            color: inherit;
            padding: 0.1em 0;
            border-radius: 2px;
        }

        /* Add border color change only when hovering name container */
        .account-name-container:hover .code-display {
            border-color: var(--primary-color);
        }

        /* Add confirmation dialog styles */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, calc(-50% + 20px)) scale(0.95);
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--hover-shadow);
            max-width: 90%;
            width: 400px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .confirm-dialog.visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .confirm-dialog-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }

        .confirm-dialog-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .confirm-dialog h3 {
            margin: 0 0 1rem;
            color: var(--text-primary);
        }

        .confirm-dialog p {
            margin: 0 0 1.5rem;
            color: var(--text-secondary);
        }

        .confirm-dialog-buttons {
            display: flex;
            gap: 1rem;
        }

        .confirm-dialog-buttons button {
            flex: 1;
        }

        .confirm-dialog-buttons .secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .confirm-dialog-buttons .danger {
            background: var(--danger-color);
        }

        .confirm-dialog-buttons .danger:hover {
            background: var(--danger-hover);
        }

        /* Update loading animation */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .code.loading {
            background: linear-gradient(90deg, 
                var(--bg-secondary) 25%, 
                var(--border-color) 50%, 
                var(--bg-secondary) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            color: transparent;
            border-radius: 4px;
        }

        /* Update copy animation */
        .code-wrapper.copied::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            font-size: 1.5rem;
            animation: pop-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pop-in {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>2FA Code Generator</h1>
        
        <div class="search-box">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search accounts..."
                autocomplete="off"
            >
        </div>

        <div class="codes-container" id="codesContainer"></div>

        <hr class="section-divider">

        <div id="addAccountSection" class="add-account-section">
            <div class="import-export">
                <button onclick="showImportDialog()">Import Accounts</button>
                <button id="toggleAddAccount" class="toggle-btn"><i class="fas fa-plus"></i></button>
                <button onclick="showExportDialog()">Export Accounts</button>
            </div>
            
            <div id="addAccountForm" class="add-account-form">
                <h2>Add New Account</h2>
        <div class="input-group">
            <label for="accountName">Account Name</label>
            <input 
                type="text" 
                id="accountName" 
                placeholder="e.g., Google, GitHub"
                autocomplete="off"
                spellcheck="false"
            >
        </div>

        <div class="input-group">
            <label for="secretKey">Secret Key</label>
            <input 
                type="text" 
                id="secretKey" 
                placeholder="Enter your secret key"
                autocomplete="off"
                spellcheck="false"
            >
        </div>

                <div class="dialog-buttons">
        <button onclick="addAccount()">Add Account</button>
                    <button class="secondary" onclick="document.getElementById('toggleAddAccount').click()">Cancel</button>
                </div>
            </div>

            <div id="editAccountDialog" class="edit-account-dialog dialog-base">
                <h2>Edit Account</h2>
                <div class="input-group">
                    <label for="editAccountName">Account Name</label>
                    <input 
                        type="text" 
                        id="editAccountName" 
                        placeholder="e.g., Google, GitHub"
                        autocomplete="off"
                        spellcheck="false"
                    >
                </div>

                <div class="input-group">
                    <label for="editSecretKey">Secret Key</label>
                    <input 
                        type="text" 
                        id="editSecretKey" 
                        placeholder="Enter your secret key"
                        autocomplete="off"
                        spellcheck="false"
                    >
                </div>

                <div class="dialog-buttons">
                    <button onclick="saveEditAccount()">Save Changes</button>
                    <button class="secondary" onclick="hideEditDialog()">Cancel</button>
                </div>
            </div>

            <div id="importDialog" class="dialog">
                <div class="dialog-content">
                    <h2>Import Accounts</h2>
                    <p class="dialog-description">Paste your accounts below, one per line:<br>Format: account|secretkey</p>
                    <textarea 
                        id="importText" 
                        placeholder="google|JBSWY3DPEHPK3PXP&#10;github|JBSWY3DPEHPK3PXP"
                        spellcheck="false"
                    ></textarea>
                    <div class="dialog-buttons">
                        <button onclick="importAccounts()">Import</button>
                        <button class="secondary" onclick="hideImportDialog()">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="exportDialog" class="dialog">
                <div class="dialog-content">
                    <h2>Export Accounts</h2>
                    <p class="dialog-description">Copy your accounts below:</p>
                    <textarea 
                        id="exportText" 
                        readonly 
                        spellcheck="false"
                    ></textarea>
                    <div class="dialog-buttons">
                        <button onclick="copyExportText()">Copy to Clipboard</button>
                        <button class="secondary" onclick="hideExportDialog()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="footer">
            <p>Made with ‚ù§Ô∏è by <a href="https://github.com/vietanhbui2000" target="_blank" rel="noopener">@vietanhbui2000</a>. Built with <a href="https://claude.ai" target="_blank" rel="noopener">Claude</a> & <a href="https://www.cursor.com" target="_blank" rel="noopener">Cursor</a>.</p>
            <p style="margin-top: 0.5rem; font-size: 0.75rem">All calculations are performed locally in your browser.</p>
        </div>
    </div>

    <div class="confirm-dialog-overlay"></div>
    <div class="confirm-dialog">
        <h3></h3>
        <p></p>
        <div class="confirm-dialog-buttons">
            <button class="confirm"></button>
            <button class="secondary cancel">Cancel</button>
        </div>
    </div>

    <script>
        // Constants
        const TOTP_INTERVAL = 30; // seconds
        const BASE32_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';

        // State management
        let accounts = [];
        let editingIndex = -1;

        // Simple tooltip texts
        const tooltipTexts = {
            edit: "Edit",
            delete: "Delete",
            copy: "Double click to copy"
        };

        // Add deleted accounts array for undo functionality
        let deletedAccounts = [];

        // Base32 decode function
        function base32ToHex(base32) {
            let bits = '';
            base32 = base32.toUpperCase().replace(/[^A-Z2-7]/g, '');
            
            for (let i = 0; i < base32.length; i++) {
                const val = BASE32_CHARS.indexOf(base32[i]);
                if (val === -1) throw new Error('Invalid base32 character');
                bits += val.toString(2).padStart(5, '0');
            }

            // Make sure the length is a multiple of 8
            bits = bits.slice(0, Math.floor(bits.length / 8) * 8);
            
            // Convert to hex
            let hex = '';
            for (let i = 0; i < bits.length; i += 8) {
                const chunk = bits.substr(i, 8);
                hex += parseInt(chunk, 2).toString(16).padStart(2, '0');
            }
            return hex;
        }

        // Generate TOTP code
        function generateTOTP(secret) {
            try {
                // Get current time period
                const epoch = Math.floor(Date.now() / 1000);
                const time = Math.floor(epoch / TOTP_INTERVAL);
                
                // Convert time to hex
                const timeHex = time.toString(16).padStart(16, '0');
                
                // Convert secret from base32 to hex
                const secretHex = base32ToHex(secret);
                
                // Calculate HMAC
                const hmac = CryptoJS.HmacSHA1(
                    CryptoJS.enc.Hex.parse(timeHex),
                    CryptoJS.enc.Hex.parse(secretHex)
                );
                
                const hmacHex = hmac.toString();
                
                // Get offset
                const offset = parseInt(hmacHex.slice(-1), 16);
                
                // Generate 4-byte code starting at offset
                const codeHex = hmacHex.substr(offset * 2, 8);
                let code = parseInt(codeHex, 16) & 0x7fffffff;
                
                // Get 6-digit code
                return (code % 1000000).toString().padStart(6, '0');
            } catch (error) {
                console.error('Error generating TOTP:', error);
                showToast('Error generating code', 'error');
                return '------';
            }
        }

        // Local storage operations
        function loadAccounts() {
            const saved = localStorage.getItem('totpAccounts');
            accounts = saved ? JSON.parse(saved) : [];
            updateAccountsDisplay();
            updateAllCodes();
        }

        function saveAccounts() {
            localStorage.setItem('totpAccounts', JSON.stringify(accounts));
        }

        // Account management
        function validateSecretKey(secret) {
            try {
                const testCode = generateTOTP(secret);
                return testCode !== '------';
            } catch {
                return false;
            }
        }

        // Add name validation
        function validateAccountName(name) {
            return name.length >= 1 && name.length <= 50 && /^[a-zA-Z0-9\s_-]+$/.test(name);
        }

        async function addAccount() {
            const nameInput = document.getElementById('accountName');
            const secretInput = document.getElementById('secretKey');
            const name = nameInput.value.trim();
            const secret = secretInput.value.trim();
            
            if (!name || !secret) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (!validateAccountName(name)) {
                showToast('Account name can only contain letters, numbers, spaces, underscores, and hyphens', 'error');
                return;
            }

            if (!validateSecretKey(secret)) {
                showToast('Invalid secret key format', 'error');
                return;
            }

            if (accounts.some(acc => acc.name === name)) {
                showToast('An account with this name already exists', 'error');
                return;
            }

            accounts.push({ name, secret });
            saveAccounts();
            updateAccountsDisplay();
            updateAllCodes();
            
            // Clear form and close it
            nameInput.value = '';
            secretInput.value = '';
            
            // Close the form
            const form = document.getElementById('addAccountForm');
            const btn = document.getElementById('toggleAddAccount');
            
            form.style.opacity = '0';
            form.style.transform = 'translateY(10px)';
            form.style.pointerEvents = 'none';
            form.style.visibility = 'hidden';
            btn.innerHTML = '<i class="fas fa-plus"></i>';
            btn.classList.remove('active');
            
            setTimeout(() => {
                form.classList.remove('visible');
            }, 300);
            
            showToast('Account added successfully', 'success');
        }

        // Update deleteAccount function with mouse leave handling
        let deleteTimeout = null;
        let deleteTarget = null;

        function deleteAccount(index, button) {
            if (deleteTimeout && deleteTarget === button) {
                // Second click - proceed with deletion
                clearTimeout(deleteTimeout);
                deleteTimeout = null;
                deleteTarget = null;
                
                const currentCodes = accounts.map((_, i) => {
                    const codeElement = document.getElementById(`code-${i}`);
                    return codeElement ? codeElement.textContent : null;
                });
                
                const deletedAccount = accounts[index];
                deletedAccounts.push({ account: deletedAccount, index });
                
                accounts.splice(index, 1);
                saveAccounts();
                updateAccountsDisplay();
                
                requestAnimationFrame(() => {
                    accounts.forEach((_, i) => {
                        const codeElement = document.getElementById(`code-${i}`);
                        if (codeElement && i < currentCodes.length && i !== index) {
                            codeElement.textContent = currentCodes[i] || generateTOTP(accounts[i].secret);
                        }
                    });
                });
                
                showToast(
                    `Account deleted. <button onclick="undoDelete()">Undo</button>`,
                    'info',
                    5000
                );
            } else {
                // First click - show confirmation state
                if (deleteTimeout) {
                    clearTimeout(deleteTimeout);
                    resetDeleteButton(deleteTarget);
                }
                
                button.classList.add('confirm');
                button.querySelector('.action-tooltip').textContent = 'Click again to delete';
                deleteTarget = button;
                
                // Add mouse leave handler
                const handleMouseLeave = () => {
                    button.removeEventListener('mouseleave', handleMouseLeave);
                    clearTimeout(deleteTimeout);
                    resetDeleteButton(button);
                    deleteTimeout = null;
                    deleteTarget = null;
                };
                
                button.addEventListener('mouseleave', handleMouseLeave);
                
                // Set timeout for 3 seconds
                deleteTimeout = setTimeout(() => {
                    resetDeleteButton(button);
                    deleteTimeout = null;
                    deleteTarget = null;
                }, 3000);
            }
        }

        // Helper function to reset delete button state
        function resetDeleteButton(button) {
            if (button) {
                button.classList.remove('confirm');
                button.querySelector('.action-tooltip').textContent = tooltipTexts.delete;
            }
        }

        function undoDelete() {
            if (deletedAccounts.length > 0) {
                const { account, index } = deletedAccounts.pop();
                accounts.splice(index, 0, account);
                saveAccounts();
                updateAccountsDisplay();
                updateAllCodes();
                showToast('Account restored', 'success');
            }
        }

        // UI updates
        function updateAccountsDisplay() {
            const container = document.getElementById('codesContainer');
            const addAccountForm = document.getElementById('addAccountForm');
            const toggleBtn = document.getElementById('toggleAddAccount');
            
            if (accounts.length === 0) {
                addAccountForm.classList.add('visible');
            } else {
                addAccountForm.classList.remove('visible');
                toggleBtn.innerHTML = '<i class="fas fa-plus"></i>';
                toggleBtn.classList.remove('active');
            }
            
            container.innerHTML = `
                <div class="codes-container-inner">
                    ${accounts.map((account, index) => `
                <div class="code-display">
                            <div class="timer-progress" id="timer-progress-${index}"></div>
                            <div class="account-name-container">
                                <div class="account-name">${account.name}</div>
                                <div class="account-actions">
                                    <button class="account-action-btn edit" onclick="showEditDialog(${index})">
                                        <i class="fas fa-pencil-alt"></i>
                                        <span class="action-tooltip">${tooltipTexts.edit}</span>
                                    </button>
                                    <button class="account-action-btn delete" onclick="deleteAccount(${index}, this)">
                                        <i class="fas fa-trash-alt"></i>
                                        <span class="action-tooltip">${tooltipTexts.delete}</span>
                                    </button>
                    </div>
                </div>
                            <div class="code-wrapper">
                                <div class="code" id="code-${index}" ondblclick="copyCode(${index})">------</div>
                                <div class="copy-indicator">Copied!</div>
                                <span class="tooltip">${tooltipTexts.copy}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Initialize timers and animations
            requestAnimationFrame(() => {
                const currentTime = Math.floor(Date.now() / 1000);
                const timeLeft = TOTP_INTERVAL - (currentTime % TOTP_INTERVAL);
                const progress = ((TOTP_INTERVAL - timeLeft) / TOTP_INTERVAL) * 100;

                accounts.forEach((_, index) => {
                    const progressElement = document.getElementById(`timer-progress-${index}`);
                    if (progressElement) {
                        // Set initial progress before adding animate class
                        progressElement.style.setProperty('--progress', `${progress}%`);
                        // Add animate class after a short delay
                        setTimeout(() => {
                            progressElement.classList.add('animate');
                        }, 50);
                    }
                });
                updateTimers();
            });
        }

        function updateAllCodes() {
            accounts.forEach((account, index) => {
                const code = generateTOTP(account.secret);
                const codeElement = document.getElementById(`code-${index}`);
                if (codeElement) {
                    codeElement.textContent = code;
                }
            });
        }

        function updateTimers() {
            const currentTime = Math.floor(Date.now() / 1000);
            const timeLeft = TOTP_INTERVAL - (currentTime % TOTP_INTERVAL);
            const progress = ((TOTP_INTERVAL - timeLeft) / TOTP_INTERVAL) * 100;

            // Update progress bars
            accounts.forEach((_, index) => {
                const progressElement = document.getElementById(`timer-progress-${index}`);
                if (progressElement) {
                    progressElement.style.setProperty('--progress', `${progress}%`);
                }
            });

            // If time is up (0 seconds left), update all codes
            if (timeLeft === 0) {
                updateAllCodes();
            }
            // Or if we're in the last 3 seconds, prepare for update
            else if (timeLeft <= 3) {
                // Schedule the update for exactly when the time hits 0
                setTimeout(() => {
                    updateAllCodes();
                }, timeLeft * 1000);
            }
        }

        // Add helper function to close all dialogs
        function closeAllDialogs() {
            const addAccountForm = document.getElementById('addAccountForm');
            const importDialog = document.getElementById('importDialog');
            const exportDialog = document.getElementById('exportDialog');
            const toggleBtn = document.getElementById('toggleAddAccount');

            // Close add account form if open
            if (addAccountForm.classList.contains('visible')) {
                addAccountForm.style.opacity = '0';
                addAccountForm.style.transform = 'translateY(10px)';
                addAccountForm.style.pointerEvents = 'none';
                addAccountForm.style.visibility = 'hidden';
                toggleBtn.innerHTML = '<i class="fas fa-plus"></i>';
                toggleBtn.classList.remove('active');
                setTimeout(() => {
                    addAccountForm.classList.remove('visible');
                }, 300);
            }

            // Close import dialog if open
            if (importDialog.classList.contains('visible')) {
                hideImportDialog();
            }

            // Close export dialog if open
            if (exportDialog.classList.contains('visible')) {
                hideExportDialog();
            }

            // Close edit dialog if open
            const editDialog = document.getElementById('editAccountDialog');
            if (editDialog.classList.contains('visible')) {
                hideEditDialog();
            }
        }

        // Update dialog open functions
        function showImportDialog() {
            const dialog = document.getElementById('importDialog');
            
            // If dialog is already visible, close it
            if (dialog.classList.contains('visible')) {
                hideImportDialog();
                return;
            }
            
            // Close any other open dialogs first
            closeAllDialogs();
            
            dialog.classList.add('visible');
            dialog.style.visibility = 'visible';
            requestAnimationFrame(() => {
                dialog.style.opacity = '1';
                dialog.style.transform = 'translateY(0)';
                dialog.style.pointerEvents = 'auto';
            });
            document.getElementById('importText').focus();
        }

        function showExportDialog() {
            const dialog = document.getElementById('exportDialog');
            
            // If dialog is already visible, close it
            if (dialog.classList.contains('visible')) {
                hideExportDialog();
                return;
            }
            
            // Close any other open dialogs first
            closeAllDialogs();
            
            const exportText = accounts.map(acc => `${acc.name}|${acc.secret}`).join('\n');
            document.getElementById('exportText').value = exportText;
            
            dialog.classList.add('visible');
            dialog.style.visibility = 'visible';
            requestAnimationFrame(() => {
                dialog.style.opacity = '1';
                dialog.style.transform = 'translateY(0)';
                dialog.style.pointerEvents = 'auto';
            });
            document.getElementById('exportText').select();
        }

        // Update toggleAddAccount event listener
        document.getElementById('toggleAddAccount').addEventListener('click', () => {
            const form = document.getElementById('addAccountForm');
            const btn = document.getElementById('toggleAddAccount');
            
            if (form.classList.contains('visible')) {
                // Close form
                form.style.opacity = '0';
                form.style.transform = 'translateY(10px)';
                form.style.pointerEvents = 'none';
                form.style.visibility = 'hidden';
                btn.innerHTML = '<i class="fas fa-plus"></i>';
                btn.classList.remove('active');
                
                setTimeout(() => {
                    form.classList.remove('visible');
                    // Clear form when closing
                    document.getElementById('accountName').value = '';
                    document.getElementById('secretKey').value = '';
                }, 300);
                btn.focus();
            } else {
                closeAllDialogs();  // Close other dialogs first
                form.classList.add('visible');
                form.style.visibility = 'visible';
                requestAnimationFrame(() => {
                    form.style.opacity = '1';
                    form.style.transform = 'translateY(0)';
                    form.style.pointerEvents = 'auto';
                });
                btn.innerHTML = '<i class="fas fa-times"></i>';
                btn.classList.add('active');
                document.getElementById('accountName').focus();
            }
        });

        // Add new functions for import/export
        async function copyExportText() {
            const text = document.getElementById('exportText').value;
            const btn = event.target;
            try {
                await navigator.clipboard.writeText(text);
                btn.classList.add('copied');
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.textContent = 'Copy to Clipboard';
                }, 1500);
            } catch (err) {
                alert('Failed to copy text to clipboard');
            }
        }

        async function importAccounts() {
            if (accounts.length > 0 && !confirm('This will add to your existing accounts. Continue?')) {
                return;
            }
            const btn = document.querySelector('#importDialog button');
            btn.disabled = true;
            btn.classList.add('button-loading');
            btn.textContent = 'Importing...';

            try {
                const text = document.getElementById('importText').value.trim();
                if (!text) {
                    alert('Please enter some accounts to import');
                    return;
                }

                const lines = text.split('\n').filter(line => line.trim());
                let imported = 0;
                let errors = [];
                let accountsToImport = [];
                
                // First pass: validate all accounts and collect errors
                lines.forEach((line, index) => {
                    const [name, secret] = line.split('|').map(s => s.trim());
                    if (name && secret) {
                        try {
                            if (validateSecretKey(secret)) {
                                if (accounts.some(acc => acc.name === name)) {
                                    errors.push(`Line ${index + 1}: Account "${name}" already exists`);
                                } else {
                                    accountsToImport.push({ name, secret });
                                }
                            } else {
                                errors.push(`Line ${index + 1}: Invalid secret key for "${name}"`);
                            }
                        } catch (error) {
                            errors.push(`Line ${index + 1}: Error processing "${name}"`);
                        }
                    }
                });

                // Show warnings first if any
                if (errors.length > 0) {
                    alert(`Import warnings:\n\n${errors.join('\n')}`);
                }

                // Then proceed with import if there are valid accounts
                if (accountsToImport.length > 0) {
                    accounts.push(...accountsToImport);
                    saveAccounts();
                    updateAccountsDisplay();
                    updateAllCodes();
                    hideImportDialog();
                    showToast(`Successfully imported ${accountsToImport.length} account(s)`, 'success');
                } else {
                    alert('No valid accounts found to import');
                }
            } finally {
                btn.disabled = false;
                btn.classList.remove('button-loading');
                btn.textContent = 'Import';
            }
        }

        // Update copy function
        async function copyCode(index) {
            try {
                const codeElement = document.getElementById(`code-${index}`);
                const code = codeElement.textContent;
                const wrapper = codeElement.parentElement;
                const indicator = wrapper.querySelector('.copy-indicator');
                
                await navigator.clipboard.writeText(code);
                
                // Add copied class for visual feedback
                wrapper.classList.add('copied');
                
                // Reset states after delay
                setTimeout(() => {
                    wrapper.classList.remove('copied');
                }, 1000);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy code to clipboard');
            }
        }

        // Update filterAccounts function
        function filterAccounts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const container = document.getElementById('codesContainer');
            const containerInner = container.querySelector('.codes-container-inner');
            const displays = document.querySelectorAll('.code-display');
            
            let hasVisibleDisplays = false;
            
            displays.forEach(display => {
                const nameElement = display.querySelector('.account-name');
                const accountName = nameElement.textContent.toLowerCase();
                
                if (!searchTerm || accountName.includes(searchTerm)) {
                    display.style.display = 'flex';
                    display.style.opacity = '1';
                    hasVisibleDisplays = true;
                    
                    // Highlight matching text
                    if (searchTerm) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        nameElement.innerHTML = nameElement.textContent.replace(
                            regex,
                            '<mark>$1</mark>'
                        );
                    } else {
                        nameElement.innerHTML = nameElement.textContent;
                    }
                } else {
                    display.style.display = 'none';
                    display.style.opacity = '0';
                }
            });

            // Update container state if no results
            if (!hasVisibleDisplays && searchTerm) {
                containerInner.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        No accounts found matching "${searchTerm}"
                    </div>
                `;
            } else if (!hasVisibleDisplays && !searchTerm) {
                // If no search term, redraw the entire accounts list and update codes
                updateAccountsDisplay();
                updateAllCodes();
            }
        }

        // Update debounce implementation
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(this, args);
                }, wait);
            };
        }

        // Initialize search with debounce
        const debouncedFilter = debounce(filterAccounts, 300);
        const searchInput = document.getElementById('searchInput');
        
        // Remove old listener and add new one
        searchInput.removeEventListener('input', filterAccounts);
        searchInput.addEventListener('input', debouncedFilter);

        // Add clear search functionality
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                searchInput.value = '';
                filterAccounts();
                searchInput.blur();
            }
        });

        // Update initialization section
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('keydown', (e) => {
                // Only keep Escape key handling for dialogs
                if (e.key === 'Escape') {
                    const form = document.getElementById('addAccountForm');
                    const importDialog = document.getElementById('importDialog');
                    const exportDialog = document.getElementById('exportDialog');
                    
                    if (form.classList.contains('visible')) {
                        document.getElementById('toggleAddAccount').click();
                    }
                    if (importDialog.classList.contains('visible')) {
                        hideImportDialog();
                    }
                    if (exportDialog.classList.contains('visible')) {
                        hideExportDialog();
                    }
                }
            });

            // Initialize app
            loadAccounts();
            // Start timer immediately
            updateTimers();
            // Then set interval
            setInterval(updateTimers, 1000);
        });

        // Update hide dialog functions
        function hideImportDialog() {
            const dialog = document.getElementById('importDialog');
            dialog.style.opacity = '0';
            dialog.style.transform = 'translateY(10px)';
            dialog.style.pointerEvents = 'none';
            dialog.style.visibility = 'hidden';
            setTimeout(() => {
                dialog.classList.remove('visible');
                document.getElementById('importText').value = '';
            }, 300);
        }

        function hideExportDialog() {
            const dialog = document.getElementById('exportDialog');
            dialog.style.opacity = '0';
            dialog.style.transform = 'translateY(10px)';
            dialog.style.pointerEvents = 'none';
            dialog.style.visibility = 'hidden';
            setTimeout(() => {
                dialog.classList.remove('visible');
            }, 300);
        }

        // Update edit dialog functionality
        function showEditDialog(index) {
            closeAllDialogs();
            editingIndex = index;
            const account = accounts[index];
            const dialog = document.getElementById('editAccountDialog');
            
            document.getElementById('editAccountName').value = account.name;
            document.getElementById('editSecretKey').value = account.secret;
            
            dialog.classList.add('visible');
            dialog.style.visibility = 'visible';
            requestAnimationFrame(() => {
                dialog.style.opacity = '1';
                dialog.style.transform = 'translateY(0)';
                dialog.style.pointerEvents = 'auto';
            });
            document.getElementById('editAccountName').focus();
        }

        function hideEditDialog() {
            const dialog = document.getElementById('editAccountDialog');
            dialog.style.opacity = '0';
            dialog.style.transform = 'translateY(10px)';
            dialog.style.pointerEvents = 'none';
            dialog.style.visibility = 'hidden';
            setTimeout(() => {
                dialog.classList.remove('visible');
                editingIndex = -1;
            }, 300);
        }

        function saveEditAccount() {
            const nameInput = document.getElementById('editAccountName');
            const secretInput = document.getElementById('editSecretKey');
            const name = nameInput.value.trim();
            const secret = secretInput.value.trim();
            
            if (!name || !secret) {
                alert('Please fill in all fields');
                return;
            }

            if (!validateAccountName(name)) {
                showToast('Account name can only contain letters, numbers, spaces, underscores, and hyphens', 'error');
                return;
            }

            if (!validateSecretKey(secret)) {
                alert('Invalid secret key format');
                return;
            }

            if (name !== accounts[editingIndex].name && accounts.some(acc => acc.name === name)) {
                alert('An account with this name already exists');
                return;
            }

            accounts[editingIndex] = { name, secret };
            saveAccounts();
            updateAccountsDisplay();
            updateAllCodes();
            hideEditDialog();
            showToast('Account updated successfully', 'success');
        }

        // Add loading states for all async operations
        function showLoadingState(button, text) {
            button.disabled = true;
            button.classList.add('button-loading');
            button.textContent = text;
        }

        function hideLoadingState(button, text) {
            button.disabled = false;
            button.classList.remove('button-loading');
            button.textContent = text;
        }

        // Add toast notifications
        function showToast(message, type = 'info', duration = 3000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            // Force reflow
            toast.offsetHeight;
            
            // Add visible class for animation
            requestAnimationFrame(() => {
                toast.classList.add('visible');
            });

            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Add custom confirm/alert functions
        function showConfirm(title, message, confirmText = 'Confirm', type = 'primary') {
            return new Promise((resolve) => {
                const dialog = document.querySelector('.confirm-dialog');
                const overlay = document.querySelector('.confirm-dialog-overlay');
                const confirmBtn = dialog.querySelector('.confirm');
                const cancelBtn = dialog.querySelector('.secondary');
                
                dialog.querySelector('h3').textContent = title;
                dialog.querySelector('p').textContent = message;
                confirmBtn.textContent = confirmText;
                confirmBtn.className = `confirm ${type}`;
                
                const hide = () => {
                    dialog.classList.remove('visible');
                    overlay.classList.remove('visible');
                };
                
                const handleConfirm = () => {
                    hide();
                    resolve(true);
                    cleanup();
                };
                
                const handleCancel = () => {
                    hide();
                    resolve(false);
                    cleanup();
                };
                
                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        handleCancel();
                    } else if (e.key === 'Enter') {
                        handleConfirm();
                    }
                };
                
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', handleConfirm);
                    cancelBtn.removeEventListener('click', handleCancel);
                    document.removeEventListener('keydown', handleKeydown);
                };
                
                confirmBtn.addEventListener('click', handleConfirm);
                cancelBtn.addEventListener('click', handleCancel);
                document.addEventListener('keydown', handleKeydown);
                
                dialog.classList.add('visible');
                overlay.classList.add('visible');
            });
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + / to focus search
            if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // Ctrl/Cmd + N to add new account
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                if (!document.getElementById('addAccountForm').classList.contains('visible')) {
                    document.getElementById('toggleAddAccount').click();
                }
            }
        });

        // Update dialog show functions
        function showDialog(dialog, focusElement) {
            dialog.classList.add('visible');
            dialog.style.visibility = 'visible';
            requestAnimationFrame(() => {
                dialog.style.opacity = '1';
                dialog.style.transform = 'translateY(0)';
                dialog.style.pointerEvents = 'auto';
                if (focusElement) {
                    focusElement.focus();
                    focusElement.select?.();
                }
            });
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>
