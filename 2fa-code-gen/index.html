<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Simple, secure 2FA code generator that works locally in your browser. Built with Claude & Cursor.">
    <meta name="theme-color" content="#007bff">
    <title>2FA Code Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-primary: #f5f5f5;
            --bg-secondary: #f8f9fa;
            --border-color: #ddd;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --transition: all 0.2s ease-in-out;
            --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-duration: 0.3s;
            --hover-transform: translateY(-2px);
            --hover-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            min-height: 100%;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        h1 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-size: 2rem;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all var(--transition-duration) var(--transition-timing);
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            font-weight: 500;
            transition: transform var(--transition-duration) var(--transition-timing),
                        box-shadow var(--transition-duration) var(--transition-timing);
        }

        button:hover {
            transform: var(--hover-transform);
            box-shadow: var(--hover-shadow);
        }

        .codes-container {
            margin: 0 -2rem;
            padding: 0 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            position: relative;
            mask-image: linear-gradient(
                to bottom,
                transparent,
                black 1rem,
                black calc(100% - 1rem),
                transparent
            );
            -webkit-mask-image: linear-gradient(
                to bottom,
                transparent,
                black 1rem,
                black calc(100% - 1rem),
                transparent
            );
        }

        .codes-container-inner {
            padding: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .code-display {
            display: flex;
            align-items: center;
            padding: var(--spacing-lg);
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            position: relative;
            border: 1px solid var(--border-color);
            gap: var(--spacing-lg);
            overflow: hidden;
            min-height: 90px;
            flex-shrink: 0;
            justify-content: space-between;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        outline-color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(0);
            outline: 2px solid transparent;
            outline-offset: 2px;
        }

        .code-display:hover {
            background-color: white;
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
            border-color: var(--border-color);
        }

        .code-display:focus-within {
            outline-color: var(--primary-color);
        }

        .account-name-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
            max-width: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .code-display:hover .account-name-container {
            transform: translateX(4px);
        }

        .account-name {
            font-weight: 500;
            font-size: 0.95rem;
            margin: 0;
            word-break: break-word;
            line-height: 1.4;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .code-display:hover .account-name {
            font-weight: 600;
            transform: scale(1.02);
        }

        .account-name-container:hover .account-name {
            color: var(--primary-color);
        }

        .account-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity var(--transition-duration) var(--transition-timing);
            flex-shrink: 0;
        }

        .account-name-container:hover .account-actions,
        .account-name-container .account-actions:has(.edit.active) {
            opacity: 1;
        }

        .account-action-btn {
            position: relative;
            background: none;
            border: none;
            padding: 0.25rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .account-action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-1px);
        }

        .account-action-btn .action-tooltip {
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            opacity: 0;
            pointer-events: none;
            transition: all var(--transition-duration) var(--transition-timing);
            white-space: nowrap;
        }

        .account-action-btn:hover .action-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-2px);
        }

        .account-action-btn.edit:hover,
        .account-action-btn.edit.active {
            color: #ffc107; /* Yellow color */
            background: rgba(255, 193, 7, 0.1);
        }

        .account-action-btn.delete:hover,
        .account-action-btn.delete.confirm {
            color: var(--danger-color);
            background: rgba(220, 53, 69, 0.1);
        }

        .account-action-btn.delete.confirm .action-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-2px);
            background: var(--danger-color);
        }

        .code-wrapper {
            position: relative;
            padding: 0.75rem 1.25rem;
            background: rgba(0, 0, 0, 0.03);
            border-radius: var(--border-radius);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            min-width: 160px;
            text-align: center;
            margin-left: auto;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .code-wrapper:hover {
            background: rgba(0, 123, 255, 0.05);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .code-wrapper.copied {
            background: rgba(0, 123, 255, 0.08);
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .code {
            font-size: 2rem;
            font-family: 'SF Mono', 'Cascadia Code', Consolas, monospace;
            color: var(--text-primary);
            letter-spacing: 3px;
            font-weight: 600;
            margin: 0;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        .code:hover {
            color: var(--primary-color);
            transform: scale(1.02);
            letter-spacing: 4px;
        }

        .delete-btn {
            background-color: transparent;
            color: var(--danger-color);
            border: none;
            width: 24px;
            height: 24px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
            padding: 0;
            line-height: 1;
            flex-shrink: 0;
            border-radius: 4px;
        }

        .account-name-container:hover .delete-btn {
            opacity: 0.7;
        }

        .delete-btn:hover {
            opacity: 1 !important;
            background-color: rgba(220, 53, 69, 0.1);
        }

        /* Update footer styles */
        .footer {
            text-align: center;
            padding: 1.5rem 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            margin: 0 -2rem -2rem; /* Remove top margin */
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            opacity: 0.9;
        }

        /* Update mobile-specific footer styles */
        @media (max-width: 768px) {
            .footer {
                padding: 1.25rem 1rem;
                margin: 0 -1rem -1rem; /* Remove top margin */
            }
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
                height: 100%;
                overscroll-behavior: none;
            }

            .container {
                padding: 1rem;
                border-radius: 0;
                min-height: 100vh;
                max-height: 100vh;
            }

            .add-account-section {
                position: sticky;
                bottom: 0;
                margin: 0 -1rem -1rem;
                border-radius: 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
            }

            .codes-container {
                margin: 0 -1rem;
                padding: 0 1rem;
            }

            /* iOS specific styles */
            @supports (-webkit-touch-callout: none) {
                body {
                    height: -webkit-fill-available;
                }
                
                .container {
                    min-height: -webkit-fill-available;
                    max-height: -webkit-fill-available;
                }
            }
        }

        .search-box {
            margin: 0 0 1.5rem 0;
            position: relative;
        }

        .search-box::after {
            content: '🔍';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            pointer-events: none;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all var(--transition-duration) var(--transition-timing);
            background: var(--bg-secondary);
        }

        .search-box input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background: white;
        }

        .add-account-section {
            background: white;
            padding: 1.75rem 2rem;
            margin: 0 -2rem;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            position: relative;
            z-index: 5;
            border-top: 1px solid var(--border-color);
        }

        .add-account-form {
            display: block;
            position: absolute;
            bottom: 100%;
            left: 1rem;
            right: 1rem;
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(10px);
            z-index: 10;
            pointer-events: none;
            visibility: hidden;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        visibility 0.3s;
        }

        .add-account-form.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }

        .add-account-form h2 {
            margin: 0 0 1rem;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .add-account-form .input-group {
            margin-bottom: 1.5rem;
        }

        .add-account-form .input-group:last-of-type {
            margin-bottom: 2rem;
        }

        .add-account-form input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            background: var(--bg-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .add-account-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            background: white;
        }

        .add-account-form button {
            margin-bottom: 0.5rem;
        }

        .import-export {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            margin: 0;
        }

        .import-export button:not(.toggle-btn) {
            flex: 1;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 120px;
            font-size: 0.95rem;
        }

        .import-export button:not(.toggle-btn):hover {
            background-color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            z-index: 10;
            line-height: 1;
        }

        .delete-btn:hover .tooltip

        .delete-btn .tooltip {
            right: calc(100% + 8px);
            top: 50%;
            transform: translateY(-50%);
        }

        .code-wrapper .tooltip {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .code-wrapper .code:hover ~ .tooltip,
        .code-wrapper.clicked .tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }

        /* Remove the checkmark animation styles */
        .code-wrapper.copied::after {
            display: none; /* Remove the checkmark */
        }

        /* Update copy indicator styles */
        .copy-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            font-weight: 500;
            font-size: 1.25rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-duration) var(--transition-timing);
        }

        .code-wrapper.copied .code {
            opacity: 0;
        }

        .code-wrapper.copied .copy-indicator {
            opacity: 1;
        }

        /* Scrollbar styles */
        @media screen and (min-width: 768px) {
            .codes-container {
                /* For Firefox */
                scrollbar-width: thin;
                scrollbar-color: transparent transparent;
            }

            .codes-container:hover {
                scrollbar-color: var(--border-color) transparent;
            }

            /* For Webkit browsers */
            .codes-container::-webkit-scrollbar {
                width: 6px;
                position: absolute;
                right: 0;
            }

            .codes-container::-webkit-scrollbar-track {
                background: transparent;
            }

            .codes-container::-webkit-scrollbar-thumb {
                background-color: var(--border-color);
                border-radius: 20px;
                border: 2px solid transparent;
                background-clip: content-box;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .codes-container:hover::-webkit-scrollbar-thumb {
                opacity: 0.5;
            }

            .codes-container:hover::-webkit-scrollbar-thumb:hover {
                opacity: 1;
                background-color: var(--text-secondary);
            }
        }

        .section-divider {
            margin: auto -2rem 0;
            height: 1px;
            background: transparent;
            border: none;
            margin-bottom: -1px; /* To prevent double border with add-account-section */
        }

        .toggle-btn {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            width: 48px;
            height: 48px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
            margin: 0 0.5rem;
            border-radius: var(--border-radius);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        }

        .toggle-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .button-loading {
            position: relative;
            color: transparent !important;
            cursor: not-allowed;
        }

        .button-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin: -8px 0 0 -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: button-loading-spinner 0.6s linear infinite;
        }

        @keyframes button-loading-spinner {
            to {
                transform: rotate(360deg);
            }
        }

        /* Update timer progress styles */
        .timer-progress {
            position: absolute;
            pointer-events: none;
            inset: 0;
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
            opacity: 0.15;
            clip-path: inset(0 0 0 0); 
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .timer-progress.animate {
            clip-path: inset(0 0 0 var(--progress));
            transition: clip-path 1s linear; 
        }

        /* Add hover effect for timer */
        .code-display:hover .timer-progress {
            opacity: 0.3;
            border-width: 3px;
        }

        /* Dialog base styles */
        .dialog,
        .edit-account-dialog,
        .add-account-form {
            position: absolute;
            bottom: 100%;
            left: 1rem;
            right: 1rem;
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius);
            box-shadow: var(--hover-shadow);
            margin-bottom: var(--spacing-md);
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            visibility: hidden;
            transition: opacity var(--transition-duration) var(--transition-timing),
                        transform var(--transition-duration) var(--transition-timing),
                        visibility var(--transition-duration);
            z-index: 10;
        }

        .dialog.visible,
        .edit-account-dialog.visible,
        .add-account-form.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
            visibility: visible;
        }

        .dialog-content {
            width: 100%;
        }

        .dialog h2,
        .edit-account-dialog h2,
        .add-account-form h2 {
            margin: 0 0 1rem;
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        .dialog-description {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .dialog textarea {
            width: 100%;
            height: 150px;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'SF Mono', 'Cascadia Code', Consolas, monospace;
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            resize: none;
            transition: all var(--transition-duration) var(--transition-timing);
        }

        .dialog textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        /* Dialog buttons */
        .dialog-buttons {
            display: flex;
            gap: 1rem;
        }

        .dialog-buttons button {
            flex: 1;
        }

        .dialog-buttons .secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .dialog-buttons .secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--text-secondary);
        }

        .dialog-buttons button.copied {
            background-color: var(--primary-color);
            color: white;
        }

        /* Update toast styles */
        .toast {
            position: fixed;
            bottom: 4rem;
            left: 50%;
            transform: translate(-50%, 100%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            pointer-events: none;
            text-align: center;
            min-width: 200px;
            max-width: 90%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .toast.visible {
            opacity: 1;
            transform: translate(-50%, 0);
            pointer-events: auto;
        }

        /* Update toast button styles */
        .toast button {
            background: none;
            border: none;
            color: white;
            text-decoration: underline;
            padding: 0;
            margin: 0;
            font-size: inherit;
            cursor: pointer;
            width: auto;
            min-width: auto;
            font-weight: normal;
        }

        .toast button:hover {
            text-decoration: none;
            transform: none;
            box-shadow: none;
            background: none;
        }

        .toast-success {
            background: rgba(40, 167, 69, 0.95);
        }

        .toast-warning {
            background: rgba(255, 193, 7, 0.95);
        }

        .toast-error {
            background: rgba(220, 53, 69, 0.95);
        }

        .toast-info {
            background: rgba(0, 123, 255, 0.95);
        }

        /* Add loading skeleton animation */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 0.3; }
            100% { opacity: 0.6; }
        }

        .code.loading {
            background: var(--border-color);
            color: transparent;
            animation: pulse 1.5s infinite;
            border-radius: 4px;
        }

        /* Add highlight for search results */
        mark {
            background-color: rgba(0, 123, 255, 0.2);
            color: inherit;
            padding: 0.1em 0;
            border-radius: 2px;
        }

        /* Add border color change only when hovering name container */
        .account-name-container:hover .code-display {
            border-color: var(--primary-color);
        }

        /* Add confirmation dialog styles */
        .confirm-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, calc(-50% + 20px)) scale(0.95);
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--hover-shadow);
            max-width: 90%;
            width: 400px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .confirm-dialog.visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .confirm-dialog-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999;
        }

        .confirm-dialog-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .confirm-dialog h3 {
            margin: 0 0 1rem;
            color: var(--text-primary);
        }

        .confirm-dialog p {
            margin: 0 0 1.5rem;
            color: var(--text-secondary);
        }

        .confirm-dialog-buttons {
            display: flex;
            gap: 1rem;
        }

        .confirm-dialog-buttons button {
            flex: 1;
        }

        .confirm-dialog-buttons .secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .confirm-dialog-buttons .danger {
            background: var(--danger-color);
        }

        .confirm-dialog-buttons .danger:hover {
            background: var(--danger-hover);
        }

        /* Update loading animation */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .code.loading {
            background: linear-gradient(90deg, 
                var(--bg-secondary) 25%, 
                var(--border-color) 50%, 
                var(--bg-secondary) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            color: transparent;
            border-radius: 4px;
        }

        /* Update copy animation */
        .code-wrapper.copied::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--primary-color);
            font-size: 1.5rem;
            animation: pop-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes pop-in {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        /* Update mobile styles */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .code-display {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
                padding: 1rem;
            }

            .account-name-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                max-width: none;
                margin-right: 0;
            }

            .account-name {
                font-size: 1rem;
                max-width: calc(100% - 80px); /* Leave space for buttons */
            }

            .account-actions {
                opacity: 1; /* Always visible on mobile */
                position: static;
                display: flex;
                gap: 0.5rem;
                margin-left: auto;
            }

            .code-wrapper {
                margin: 0;
                width: 100%;
                padding: 0.75rem;
                background: rgba(0, 0, 0, 0.02);
                cursor: pointer;
            }

            .code {
                font-size: 1.75rem;
                letter-spacing: 2px;
            }

            /* Remove double-click requirement on mobile */
            .code-wrapper .tooltip {
                display: none;
            }

            /* Update copy feedback for single tap */
            .code-wrapper.copied::after {
                display: none;
            }

            /* Improve tap targets */
            .account-action-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }

            /* Hide tooltips on mobile */
            .action-tooltip {
                display: none;
            }

            /* Adjust timer progress for mobile */
            .timer-progress {
                border-width: 1.5px;
            }

            /* Update mobile tap feedback */
            .account-action-btn:active {
                transform: scale(0.95);
            }

            .account-action-btn.edit:active {
                color: #ffc107;
                background: rgba(255, 193, 7, 0.15);
            }

            .account-action-btn.delete:active {
                color: var(--danger-color);
                background: rgba(220, 53, 69, 0.15);
            }

            /* Update delete button confirmation state on mobile */
            .account-action-btn.delete.confirm {
                color: var(--danger-color);
                background: rgba(220, 53, 69, 0.15);
                transform: scale(0.95);
            }

            /* Remove hover effects on mobile */
            .account-action-btn:hover {
                transform: none;
                background: none;
            }

            /* Keep active state styles */
            .account-action-btn:active,
            .account-action-btn.confirm {
                transform: scale(0.95);
            }

            /* Update mobile copy indicator */
            .copy-indicator {
                font-size: 1.1rem;
            }
        }

        .input-group input:invalid {
            border-color: var(--danger-color);
        }

        .input-group .validation-message {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .input-group input:invalid + .validation-message {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>2FA Code Generator</h1>
        
        <div class="search-box">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search accounts..."
                autocomplete="off"
            >
        </div>

        <div class="codes-container" id="codesContainer"></div>

        <hr class="section-divider">

        <div id="addAccountSection" class="add-account-section">
            <div class="import-export">
                <button onclick="showImportDialog()">Import Accounts</button>
                <button id="toggleAddAccount" class="toggle-btn"><i class="fas fa-plus"></i></button>
                <button onclick="showExportDialog()">Export Accounts</button>
            </div>
            
            <div id="addAccountForm" class="add-account-form">
                <h2>Add New Account</h2>
        <div class="input-group">
            <label for="accountName">Account Name</label>
            <input 
                type="text" 
                id="accountName" 
                placeholder="e.g., Google, GitHub"
                autocomplete="off"
                spellcheck="false"
                pattern="^[^|\\\n\r<>]{1,50}$"
                title="Name cannot contain | \ or HTML tags"
            >
            <div class="validation-message">Name cannot contain | \ or HTML tags</div>
        </div>

        <div class="input-group">
            <label for="secretKey">Secret Key</label>
            <input 
                type="text" 
                id="secretKey" 
                placeholder="Enter your secret key"
                autocomplete="off"
                spellcheck="false"
            >
        </div>

                <div class="dialog-buttons">
        <button onclick="addAccount()">Add Account</button>
                    <button class="secondary" onclick="document.getElementById('toggleAddAccount').click()">Cancel</button>
                </div>
            </div>

            <div id="editAccountDialog" class="edit-account-dialog dialog-base">
                <h2>Edit Account</h2>
                <div class="input-group">
                    <label for="editAccountName">Account Name</label>
                    <input 
                        type="text" 
                        id="editAccountName" 
                        placeholder="e.g., Google, GitHub"
                        autocomplete="off"
                        spellcheck="false"
                    >
                </div>

                <div class="input-group">
                    <label for="editSecretKey">Secret Key</label>
                    <input 
                        type="text" 
                        id="editSecretKey" 
                        placeholder="Enter your secret key"
                        autocomplete="off"
                        spellcheck="false"
                    >
                </div>

                <div class="dialog-buttons">
                    <button onclick="saveEditAccount()">Save Changes</button>
                    <button class="secondary" onclick="hideEditDialog()">Cancel</button>
                </div>
            </div>

            <div id="importDialog" class="dialog">
                <div class="dialog-content">
                    <h2>Import Accounts</h2>
                    <p class="dialog-description">Paste your accounts below, one per line:<br>Format: account|secretkey</p>
                    <textarea 
                        id="importText" 
                        placeholder="google|JBSWY3DPEHPK3PXP&#10;github|JBSWY3DPEHPK3PXP"
                        spellcheck="false"
                    ></textarea>
                    <div class="dialog-buttons">
                        <button onclick="importAccounts()">Import</button>
                        <button class="secondary" onclick="hideImportDialog()">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="exportDialog" class="dialog">
                <div class="dialog-content">
                    <h2>Export Accounts</h2>
                    <p class="dialog-description">Copy your accounts below:</p>
                    <textarea 
                        id="exportText" 
                        readonly 
                        spellcheck="false"
                    ></textarea>
                    <div class="dialog-buttons">
                        <button onclick="copyExportText()">Copy to Clipboard</button>
                        <button class="secondary" onclick="hideExportDialog()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    
        <div class="footer">
            <p>Made with ❤️ by <a href="https://github.com/vietanhbui2000" target="_blank" rel="noopener">@vietanhbui2000</a>.<br>
            Built with <a href="https://claude.ai" target="_blank" rel="noopener">Claude</a> & <a href="https://www.cursor.com" target="_blank" rel="noopener">Cursor</a>.</p>
            <p style="margin-top: 0.5rem; font-size: 0.75rem">All calculations are performed locally in your browser.</p>
        </div>
    </div>

    <div class="confirm-dialog-overlay"></div>
    <div class="confirm-dialog">
        <h3></h3>
        <p></p>
        <div class="confirm-dialog-buttons">
            <button class="confirm"></button>
            <button class="secondary cancel">Cancel</button>
        </div>
    </div>

    <script>
        // Constants
        const TOTP_INTERVAL = 30; // seconds
        const BASE32_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';

        // State management
        let accounts = [];
        let editingIndex = -1;
        let activeButton = null; // Track currently active button

        // Simple tooltip texts
        const tooltipTexts = {
            edit: "Edit",
            delete: "Delete",
            copy: "Double click to copy"
        };

        // Add deleted accounts array for undo functionality
        let deletedAccounts = [];

        // Base32 decode function
        function base32ToHex(base32) {
            let bits = '';
            base32 = base32.toUpperCase().replace(/[^A-Z2-7]/g, '');
            
            for (let i = 0; i < base32.length; i++) {
                const val = BASE32_CHARS.indexOf(base32[i]);
                if (val === -1) return ''; // Return empty string instead of throwing error
                bits += val.toString(2).padStart(5, '0');
            }

            // Make sure the length is a multiple of 8
            bits = bits.slice(0, Math.floor(bits.length / 8) * 8);
            
            // Convert to hex
            let hex = '';
            for (let i = 0; i < bits.length; i += 8) {
                const chunk = bits.substr(i, 8);
                hex += parseInt(chunk, 2).toString(16).padStart(2, '0');
            }
            return hex;
        }

        // Generate TOTP code
        function generateTOTP(secret) {
            try {
                // Get current time period
                const epoch = Math.floor(Date.now() / 1000);
                const time = Math.floor(epoch / TOTP_INTERVAL);
                
                // Convert time to hex
                const timeHex = time.toString(16).padStart(16, '0');
                
                // Convert secret from base32 to hex
                const secretHex = base32ToHex(secret);
                if (!secretHex) return '------'; // Handle empty secret
                
                // Calculate HMAC
                const hmac = CryptoJS.HmacSHA1(
                    CryptoJS.enc.Hex.parse(timeHex),
                    CryptoJS.enc.Hex.parse(secretHex)
                );
                
                const hmacHex = hmac.toString();
                
                // Get offset
                const offset = parseInt(hmacHex.slice(-1), 16);
                
                // Generate 4-byte code starting at offset
                const codeHex = hmacHex.substr(offset * 2, 8);
                let code = parseInt(codeHex, 16) & 0x7fffffff;
                
                // Get 6-digit code
                return (code % 1000000).toString().padStart(6, '0');
            } catch (error) {
                console.error('Error generating TOTP:', error);
                return '------';
            }
        }

        // Local storage operations
        function loadAccounts() {
            const saved = localStorage.getItem('totpAccounts');
            accounts = saved ? JSON.parse(saved) : [];
            updateAccountsDisplay();
            updateAllCodes();
        }

        function saveAccounts() {
            try {
                localStorage.setItem('totpAccounts', JSON.stringify(accounts));
                showToast('Changes saved', 'success', 1000);
            } catch (error) {
                showToast('Failed to save changes', 'error');
                console.error('Save error:', error);
            }
        }

        // Account management
        function validateSecretKey(secret) {
            if (!secret || typeof secret !== 'string') return false;
            
            // Quick validation before generating code
            const cleanedSecret = secret.toUpperCase().replace(/[^A-Z2-7]/g, '');
            if (cleanedSecret.length < 8) return false; // Too short to be valid
            
            try {
                const testCode = generateTOTP(secret);
                return testCode !== '------';
            } catch {
                return false;
            }
        }

        // Update name validation
        function validateAccountName(name) {
            // Only restrict characters that could cause issues with HTML/JavaScript
            return name.length >= 1 && 
                   name.length <= 50 && 
                   !/<[^>]*>/.test(name) && // Prevent HTML tags
                   !/[\|\\\n\r]/.test(name); // Prevent characters that could break import/export
        }

        async function addAccount() {
            const nameInput = document.getElementById('accountName');
            const secretInput = document.getElementById('secretKey');
            const name = nameInput.value.trim();
            const secret = secretInput.value.trim();
            
            if (!name || !secret) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (!validateAccountName(name)) {
                if (name.length < 1 || name.length > 50) {
                    showToast('Account name must be between 1 and 50 characters', 'error');
                } else if (/<[^>]*>/.test(name)) {
                    showToast('Account name cannot contain HTML tags', 'error');
                } else if (/[\|\\\n\r]/.test(name)) {
                    showToast('Account name cannot contain | \\ or line breaks', 'error');
                }
                return;
            }

            if (!validateSecretKey(secret)) {
                showToast('Invalid secret key format', 'error');
                return;
            }

            if (accounts.some(acc => acc.name === name)) {
                showToast('An account with this name already exists', 'error');
                return;
            }

            accounts.push({ name, secret });
            saveAccounts();
            updateAccountsDisplay();
            updateAllCodes();
            
            // Clear form and close it
            nameInput.value = '';
            secretInput.value = '';
            
            // Close the form
            const form = document.getElementById('addAccountForm');
            const btn = document.getElementById('toggleAddAccount');
            
            form.style.opacity = '0';
            form.style.transform = 'translateY(10px)';
            form.style.pointerEvents = 'none';
            form.style.visibility = 'hidden';
            btn.innerHTML = '<i class="fas fa-plus"></i>';
            btn.classList.remove('active');
            
            setTimeout(() => {
                form.classList.remove('visible');
            }, 300);
            
            showToast('Account added successfully', 'success');
        }

        // Update deleteAccount function
        let deleteTimeout = null;
        let deleteTarget = null;

        function deleteAccount(index, button) {
            // If there's an active button and it's not this one, reset it
            if (activeButton && activeButton !== button) {
                if (activeButton.classList.contains('edit')) {
                    hideEditDialog();
                } else if (activeButton.classList.contains('delete')) {
                    resetDeleteButton(activeButton);
                    clearTimeout(deleteTimeout);
                    deleteTimeout = null;
                    deleteTarget = null;
                }
            }
            
            activeButton = button;
            const isMobile = window.innerWidth <= 768;
            
            if (deleteTimeout && deleteTarget === button) {
                // Second click/tap - proceed with deletion
                clearTimeout(deleteTimeout);
                deleteTimeout = null;
                deleteTarget = null;
                
                const currentCodes = accounts.map((_, i) => {
                    const codeElement = document.getElementById(`code-${i}`);
                    return codeElement ? codeElement.textContent : null;
                });
                
                const deletedAccount = accounts[index];
                deletedAccounts.push({ account: deletedAccount, index });
                
                accounts.splice(index, 1);
                saveAccounts();
                updateAccountsDisplay();
                
                requestAnimationFrame(() => {
                    accounts.forEach((_, i) => {
                        const codeElement = document.getElementById(`code-${i}`);
                        if (codeElement && i < currentCodes.length && i !== index) {
                            codeElement.textContent = currentCodes[i] || generateTOTP(accounts[i].secret);
                        }
                    });
                });
                
                showToast(
                    `Account deleted. <button onclick="undoDelete()">Undo</button>`,
                    'info',
                    5000
                );
                
                // Reset active button after deletion
                activeButton = null;
            } else {
                // First click/tap - show confirmation state
                if (deleteTimeout) {
                    clearTimeout(deleteTimeout);
                    resetDeleteButton(deleteTarget);
                }
                
                button.classList.add('confirm');
                button.querySelector('.action-tooltip').textContent = 'Click again to delete';
                deleteTarget = button;
                
                if (!isMobile) {
                    // Only add mouse leave handler on desktop
                    const handleMouseLeave = () => {
                        button.removeEventListener('mouseleave', handleMouseLeave);
                        clearTimeout(deleteTimeout);
                        resetDeleteButton(button);
                        deleteTimeout = null;
                        deleteTarget = null;
                    };
                    button.addEventListener('mouseleave', handleMouseLeave);
                }
                
                // Set timeout for confirmation state
                deleteTimeout = setTimeout(() => {
                    resetDeleteButton(button);
                    deleteTimeout = null;
                    deleteTarget = null;
                }, 3000);
            }
        }

        // Helper function to reset delete button state
        function resetDeleteButton(button) {
            if (button) {
                button.classList.remove('confirm');
                button.querySelector('.action-tooltip').textContent = tooltipTexts.delete;
                activeButton = null; // Reset active button
            }
        }

        function undoDelete() {
            if (deletedAccounts.length > 0) {
                const { account, index } = deletedAccounts.pop();
                accounts.splice(index, 0, account);
                saveAccounts();
                updateAccountsDisplay();
                updateAllCodes();
                showToast('Account restored', 'success');
            }
        }

        // UI updates
        function updateAccountsDisplay() {
            const container = document.getElementById('codesContainer');
            const addAccountForm = document.getElementById('addAccountForm');
            const toggleBtn = document.getElementById('toggleAddAccount');
            
            if (accounts.length === 0) {
                addAccountForm.classList.add('visible');
            } else {
                addAccountForm.classList.remove('visible');
                toggleBtn.innerHTML = '<i class="fas fa-plus"></i>';
                toggleBtn.classList.remove('active');
            }
            
            const isMobile = window.innerWidth <= 768;
            const clickEvent = isMobile ? 'onclick' : 'ondblclick';
            
            // Create HTML string once instead of using template literals in a loop
            let html = '<div class="codes-container-inner">';
            
            for (let index = 0; index < accounts.length; index++) {
                const account = accounts[index];
                html += `
                    <div class="code-display">
                        <div class="timer-progress" id="timer-progress-${index}"></div>
                        <div class="account-name-container">
                            <div class="account-name">${account.name}</div>
                            <div class="account-actions">
                                <button class="account-action-btn edit" onclick="showEditDialog(${index})">
                                    <i class="fas fa-pencil-alt"></i>
                                    <span class="action-tooltip">${tooltipTexts.edit}</span>
                                </button>
                                <button class="account-action-btn delete" onclick="deleteAccount(${index}, this)">
                                    <i class="fas fa-trash-alt"></i>
                                    <span class="action-tooltip">${tooltipTexts.delete}</span>
                                </button>
                            </div>
                        </div>
                        <div class="code-wrapper" id="code-wrapper-${index}">
                            <div class="code" id="code-${index}">------</div>
                            <div class="copy-indicator">Copied!</div>
                            <span class="tooltip">${tooltipTexts.copy}</span>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;

            // Initialize timers and animations
            if (accounts.length > 0) {
                requestAnimationFrame(() => {
                    const currentTime = Math.floor(Date.now() / 1000);
                    const timeLeft = TOTP_INTERVAL - (currentTime % TOTP_INTERVAL);
                    const progress = ((TOTP_INTERVAL - timeLeft) / TOTP_INTERVAL) * 100;

                    for (let index = 0; index < accounts.length; index++) {
                        const progressElement = document.getElementById(`timer-progress-${index}`);
                        if (progressElement) {
                            // Set initial progress before adding animate class
                            progressElement.style.setProperty('--progress', `${progress}%`);
                            // Add animate class after a short delay
                            setTimeout(() => {
                                progressElement.classList.add('animate');
                            }, 50);
                        }
                    }
                    updateTimers();

                    // Add click handlers to all code wrappers
                    for (let index = 0; index < accounts.length; index++) {
                        attachCodeCopyEvents(index);
                    }
                });
            }
        }

        // New function to attach copy events to code wrappers
        function attachCodeCopyEvents(index) {
            const wrapper = document.getElementById(`code-wrapper-${index}`);
            const isMobile = window.innerWidth <= 768;
            
            if (!wrapper) return;
            
            // Remove previous listeners (if any)
            wrapper.removeEventListener('click', handleClick);
            wrapper.removeEventListener('dblclick', handleDblClick);
            
            // Add click handler to show tooltip
            wrapper.addEventListener('click', handleClick);
            
            // Add double-click handler to copy code
            if (!isMobile) {
                wrapper.addEventListener('dblclick', handleDblClick);
            }
            
            function handleClick(e) {
                if (isMobile) {
                    copyCode(index);
                } else {
                    // On desktop, just show tooltip on single click
                    wrapper.classList.add('clicked');
                    
                    // Remove the clicked class after a delay
                    setTimeout(() => {
                        wrapper.classList.remove('clicked');
                    }, 1500);
                }
            }
            
            function handleDblClick(e) {
                copyCode(index);
            }
        }

        // Update copyCode function to be more reliable
        function copyCode(index) {
            const codeElement = document.getElementById(`code-${index}`);
            const wrapper = document.getElementById(`code-wrapper-${index}`);
            
            if (!codeElement || !wrapper) return;
            
            (async function() {
                try {
                    const code = codeElement.textContent;
                    await navigator.clipboard.writeText(code);
                    
                    wrapper.classList.add('copied');
                    setTimeout(() => {
                        wrapper.classList.remove('copied');
                    }, 1000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                    showToast('Failed to copy code to clipboard', 'error');
                }
            })();
        }

        // Optimize updateAllCodes function
        function updateAllCodes() {
            for (let index = 0; index < accounts.length; index++) {
                const code = generateTOTP(accounts[index].secret);
                const codeElement = document.getElementById(`code-${index}`);
                if (codeElement) {
                    codeElement.textContent = code;
                }
            }
        }

        // Optimize updateTimers function
        function updateTimers() {
            const currentTime = Math.floor(Date.now() / 1000);
            const timeLeft = TOTP_INTERVAL - (currentTime % TOTP_INTERVAL);
            const progress = ((TOTP_INTERVAL - timeLeft) / TOTP_INTERVAL) * 100;

            // Update progress bars
            for (let index = 0; index < accounts.length; index++) {
                const progressElement = document.getElementById(`timer-progress-${index}`);
                if (progressElement) {
                    progressElement.style.setProperty('--progress', `${progress}%`);
                }
            }

            // If time is up (0 seconds left), update all codes
            if (timeLeft === 0) {
                updateAllCodes();
            }
            // Or if we're in the last 3 seconds, prepare for update
            else if (timeLeft <= 3) {
                // Schedule the update for exactly when the time hits 0
                setTimeout(() => {
                    updateAllCodes();
                }, timeLeft * 1000);
            }
        }

        // Add helper function to close all dialogs
        function closeAllDialogs() {
            const addAccountForm = document.getElementById('addAccountForm');
            const importDialog = document.getElementById('importDialog');
            const exportDialog = document.getElementById('exportDialog');
            const editDialog = document.getElementById('editAccountDialog');
            const toggleBtn = document.getElementById('toggleAddAccount');

            // Close add account form if open
            if (addAccountForm.classList.contains('visible')) {
                addAccountForm.style.opacity = '0';
                addAccountForm.style.transform = 'translateY(10px)';
                addAccountForm.style.pointerEvents = 'none';
                addAccountForm.style.visibility = 'hidden';
                toggleBtn.innerHTML = '<i class="fas fa-plus"></i>';
                toggleBtn.classList.remove('active');
                
                setTimeout(() => {
                    addAccountForm.classList.remove('visible');
                }, 300);
            }

            // Close import dialog if open
            if (importDialog.classList.contains('visible')) {
                hideImportDialog();
            }

            // Close export dialog if open
            if (exportDialog.classList.contains('visible')) {
                hideExportDialog();
            }

            // Close edit dialog if open
            if (editDialog.classList.contains('visible')) {
                hideEditDialog();
            }

            // Reset any active delete button
            if (activeButton && activeButton.classList.contains('delete')) {
                resetDeleteButton(activeButton);
                clearTimeout(deleteTimeout);
                deleteTimeout = null;
                deleteTarget = null;
            }
            
            // Reset any active edit button
            if (activeButton && activeButton.classList.contains('edit')) {
                activeButton.classList.remove('active');
            }
            
            activeButton = null;
        }

        // Update dialog open functions
        function showImportDialog() {
            const dialog = document.getElementById('importDialog');
            
            // If dialog is already visible, close it
            if (dialog.classList.contains('visible')) {
                hideImportDialog();
                return;
            }
            
            // Close any other open dialogs first
            closeAllDialogs();
            
            dialog.classList.add('visible');
            dialog.style.visibility = 'visible';
            dialog.style.opacity = '1';
            dialog.style.transform = 'translateY(0)';
            dialog.style.pointerEvents = 'auto';
            
            document.getElementById('importText').focus();
        }

        function showExportDialog() {
            const dialog = document.getElementById('exportDialog');
            
            // If dialog is already visible, close it
            if (dialog.classList.contains('visible')) {
                hideExportDialog();
                return;
            }
            
            // Close any other open dialogs first
            closeAllDialogs();
            
            const exportText = accounts.map(acc => `${acc.name}|${acc.secret}`).join('\n');
            document.getElementById('exportText').value = exportText;
            
            dialog.classList.add('visible');
            dialog.style.visibility = 'visible';
            dialog.style.opacity = '1';
            dialog.style.transform = 'translateY(0)';
            dialog.style.pointerEvents = 'auto';
            
            document.getElementById('exportText').select();
        }

        // Update toggleAddAccount event listener
        document.getElementById('toggleAddAccount').addEventListener('click', function() {
            const form = document.getElementById('addAccountForm');
            const btn = document.getElementById('toggleAddAccount');
            
            if (form.classList.contains('visible')) {
                // Close form
                form.style.opacity = '0';
                form.style.transform = 'translateY(10px)';
                form.style.pointerEvents = 'none';
                form.style.visibility = 'hidden';
                btn.innerHTML = '<i class="fas fa-plus"></i>';
                btn.classList.remove('active');
                
                setTimeout(() => {
                    form.classList.remove('visible');
                    // Clear form when closing
                    document.getElementById('accountName').value = '';
                    document.getElementById('secretKey').value = '';
                }, 300);
                btn.focus();
            } else {
                closeAllDialogs();  // Close other dialogs first
                form.classList.add('visible');
                form.style.visibility = 'visible';
                form.style.opacity = '1';
                form.style.transform = 'translateY(0)';
                form.style.pointerEvents = 'auto';
                
                btn.innerHTML = '<i class="fas fa-times"></i>';
                btn.classList.add('active');
                document.getElementById('accountName').focus();
            }
        });

        // Add new functions for import/export
        async function copyExportText() {
            const text = document.getElementById('exportText').value;
            const btn = event.target;
            try {
                await navigator.clipboard.writeText(text);
                showToast('Accounts copied to clipboard', 'success');
                hideExportDialog();
            } catch (err) {
                showToast('Failed to copy to clipboard', 'error');
            }
        }

        async function importAccounts() {
            if (accounts.length > 0) {
                const confirmed = await showConfirm(
                    'Import Accounts',
                    'This will add to your existing accounts. Continue?',
                    'Import'
                );
                if (!confirmed) return;
            }

            const btn = document.querySelector('#importDialog button');
            showLoadingState(btn, 'Importing...');

            try {
                const text = document.getElementById('importText').value.trim();
                if (!text) {
                    showToast('Please enter some accounts to import', 'error');
                    return;
                }

                const lines = text.split('\n').filter(line => line.trim());
                let imported = 0;
                let errors = [];
                let accountsToImport = [];
                
                lines.forEach((line, index) => {
                    const [name, secret] = line.split('|').map(s => s.trim());
                    if (!name || !secret) {
                        errors.push(`Line ${index + 1}: Invalid format. Expected "name|secret"`);
                        return;
                    }
                    
                    if (!validateAccountName(name)) {
                        if (name.length < 1 || name.length > 50) {
                            errors.push(`Line ${index + 1}: Account name "${name}" must be between 1 and 50 characters`);
                        } else if (/<[^>]*>/.test(name)) {
                            errors.push(`Line ${index + 1}: Account name cannot contain HTML tags`);
                        } else if (/[\|\\\n\r]/.test(name)) {
                            errors.push(`Line ${index + 1}: Account name cannot contain | \\ or line breaks`);
                        }
                        return;
                    }

                    if (!validateSecretKey(secret)) {
                        errors.push(`Line ${index + 1}: Invalid secret key for "${name}"`);
                        return;
                    }

                    if (accounts.some(acc => acc.name === name)) {
                        errors.push(`Line ${index + 1}: Account "${name}" already exists`);
                        return;
                    }

                    accountsToImport.push({ name, secret });
                });

                if (errors.length > 0) {
                    showToast(`Import warnings:\n\n${errors.join('\n')}`, 'warning', 5000);
                }

                if (accountsToImport.length > 0) {
                    accounts.push(...accountsToImport);
                    saveAccounts();
                    updateAccountsDisplay();
                    updateAllCodes();
                    hideImportDialog();
                    showToast(`Successfully imported ${accountsToImport.length} account(s)`, 'success');
                } else if (errors.length === 0) {
                    showToast('No valid accounts found to import', 'error');
                }
            } finally {
                hideLoadingState(btn, 'Import');
            }
        }

        // Optimize filterAccounts function
        function filterAccounts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const container = document.getElementById('codesContainer');
            const containerInner = container.querySelector('.codes-container-inner');
            const displays = document.querySelectorAll('.code-display');
            
            let hasVisibleDisplays = false;
            
            if (!searchTerm) {
                // If no search term, show all accounts
                displays.forEach(display => {
                    display.style.display = 'flex';
                    display.style.opacity = '1';
                    const nameElement = display.querySelector('.account-name');
                    nameElement.innerHTML = nameElement.textContent;
                });
                hasVisibleDisplays = displays.length > 0;
            } else {
                // If search term exists, filter accounts
                displays.forEach(display => {
                    const nameElement = display.querySelector('.account-name');
                    const accountName = nameElement.textContent.toLowerCase();
                    
                    if (accountName.includes(searchTerm)) {
                        display.style.display = 'flex';
                        display.style.opacity = '1';
                        hasVisibleDisplays = true;
                        
                        // Highlight matching text
                        const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                        nameElement.innerHTML = nameElement.textContent.replace(
                            regex,
                            '<mark>$1</mark>'
                        );
                    } else {
                        display.style.display = 'none';
                        display.style.opacity = '0';
                    }
                });
            }

            // Update container state if no results
            if (!hasVisibleDisplays && searchTerm) {
                containerInner.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        No accounts found matching "${searchTerm}"
                    </div>
                `;
            } else if (!hasVisibleDisplays && !searchTerm) {
                // If no search term, redraw the entire accounts list and update codes
                updateAccountsDisplay();
                updateAllCodes();
            }
        }

        // Update debounce implementation
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(this, args);
                }, wait);
            };
        }

        // Initialize search with debounce
        const debouncedFilter = debounce(filterAccounts, 300);
        const searchInput = document.getElementById('searchInput');
        
        // Remove old listener and add new one
        searchInput.removeEventListener('input', filterAccounts);
        searchInput.addEventListener('input', debouncedFilter);

        // Add clear search functionality
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                searchInput.value = '';
                filterAccounts();
                searchInput.blur();
            }
        });

        // Initialize app with optimized event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Use a single event listener for escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllDialogs();
                    
                    // Clear search if focused and no dialogs are open
                    const searchInput = document.getElementById('searchInput');
                    if (document.activeElement === searchInput) {
                        searchInput.value = '';
                        filterAccounts();
                        searchInput.blur();
                    }
                } else if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    if (!document.getElementById('addAccountForm').classList.contains('visible')) {
                        document.getElementById('toggleAddAccount').click();
                    }
                }
            });

            // Initialize app
            loadAccounts();
            // Start timer immediately
            updateTimers();
            // Then set interval
            setInterval(updateTimers, 1000);
        });
        
        // Register service worker with error handling
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Fix showEditDialog function
        function showEditDialog(index) {
            const editButton = document.querySelector(`.code-display:nth-child(${index + 1}) .account-action-btn.edit`);
            
            // If there's an active button and it's not this one, reset it
            if (activeButton && activeButton !== editButton) {
                if (activeButton.classList.contains('delete')) {
                    resetDeleteButton(activeButton);
                    clearTimeout(deleteTimeout);
                    deleteTimeout = null;
                    deleteTarget = null;
                } else if (activeButton.classList.contains('edit')) {
                    hideEditDialog();
                }
            }
            
            // Call closeAllDialogs before setting new active button
            closeAllDialogs();
            activeButton = editButton;
            editingIndex = index;
            
            const account = accounts[index];
            const dialog = document.getElementById('editAccountDialog');
            
            editButton.classList.add('active');
            
            document.getElementById('editAccountName').value = account.name;
            document.getElementById('editSecretKey').value = account.secret;
            
            dialog.classList.add('visible');
            dialog.style.visibility = 'visible';
            dialog.style.opacity = '1';
            dialog.style.transform = 'translateY(0)';
            dialog.style.pointerEvents = 'auto';
            
            document.getElementById('editAccountName').focus();
        }

        // Fix hideEditDialog function
        function hideEditDialog() {
            const dialog = document.getElementById('editAccountDialog');
            const activeEditButton = document.querySelector('.account-action-btn.edit.active');
            if (activeEditButton) {
                activeEditButton.classList.remove('active');
            }
            activeButton = null; // Reset active button
            
            dialog.style.opacity = '0';
            dialog.style.transform = 'translateY(10px)';
            dialog.style.pointerEvents = 'none';
            dialog.style.visibility = 'hidden';
            setTimeout(() => {
                dialog.classList.remove('visible');
                editingIndex = -1;
            }, 300);
        }

        // Fix hideImportDialog function
        function hideImportDialog() {
            const dialog = document.getElementById('importDialog');
            dialog.style.opacity = '0';
            dialog.style.transform = 'translateY(10px)';
            dialog.style.pointerEvents = 'none';
            dialog.style.visibility = 'hidden';
            setTimeout(() => {
                dialog.classList.remove('visible');
                document.getElementById('importText').value = '';
            }, 300);
        }

        // Fix hideExportDialog function
        function hideExportDialog() {
            const dialog = document.getElementById('exportDialog');
            dialog.style.opacity = '0';
            dialog.style.transform = 'translateY(10px)';
            dialog.style.pointerEvents = 'none';
            dialog.style.visibility = 'hidden';
            setTimeout(() => {
                dialog.classList.remove('visible');
            }, 300);
        }
    </script>
</body>
</html>
